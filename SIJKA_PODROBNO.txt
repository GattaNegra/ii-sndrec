#include <WiFi.h>          // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ –±–µ–∑–∂–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
#include <WebServer.h>     // –ó–∞ –¥–∞ –≤–∏–∂–¥–∞—à —É–µ–± —Å–∞–π—Ç–∞ –≤ –±—Ä–∞—É–∑—ä—Ä–∞
#include <SPI.h>           // –ö–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å—ä—Å SD –∫–∞—Ä—Ç–∞—Ç–∞
#include <SD.h>            // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–≤–µ—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞
#include <driver/i2s.h>    // –°–ø–µ—Ü–∏–∞–ª–Ω–∏—è—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª –∑–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (I2S)
#include <Wire.h>          // –ó–∞ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å —á–∞—Å–æ–≤–Ω–∏–∫–∞ (I2C)
#include "RTClib.h"        // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞ (Real Time Clock)

// –î–ï–§–ò–ù–ò–†–ê–ù–ï –ù–ê –ü–ò–ù–û–í–ï (–ö–æ–π –∫–∞–±–µ–ª –∫—ä–¥–µ –æ—Ç–∏–≤–∞)
#define I2S_WS 25          // Word Select (–õ—è–≤/–î–µ—Å–µ–Ω –∫–∞–Ω–∞–ª)
#define I2S_SD 33          // Serial Data (–ê—É–¥–∏–æ –¥–∞–Ω–Ω–∏—Ç–µ)
#define I2S_SCK 32         // Serial Clock (–¢–∞–∫—Ç–æ–≤ —Å–∏–≥–Ω–∞–ª)
#define SD_CS 5            // Chip Select –∑–∞ SD –∫–∞—Ä—Ç–∞—Ç–∞
#define SD_MOSI 23         // –î–∞–Ω–Ω–∏ –∫—ä–º SD –∫–∞—Ä—Ç–∞—Ç–∞
#define SD_MISO 19         // –î–∞–Ω–Ω–∏ –æ—Ç SD –∫–∞—Ä—Ç–∞—Ç–∞
#define SD_SCK 18          // –¢–∞–∫—Ç –∑–∞ SD –∫–∞—Ä—Ç–∞—Ç–∞
#define I2C_SDA 21         // –î–∞–Ω–Ω–∏ –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞
#define I2C_SCL 22         // –¢–∞–∫—Ç –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞
#define BTN_PIN 0          // –í–≥—Ä–∞–¥–µ–Ω–∏—è—Ç –±—É—Ç–æ–Ω BOOT –Ω–∞ –ø–ª–∞—Ç–∫–∞—Ç–∞

// –î–ê–ù–ù–ò –ó–ê –¢–í–û–Ø–¢–ê –î–û–ú–ê–®–ù–ê –ú–†–ï–ñ–ê
const char* ssid = "WIFINETNAME";
const char* pass = "PASS";

RTC_DS3231 rtc;            // –û–±–µ–∫—Ç –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞
WebServer server(80);      // –£–µ–± —Å—ä—Ä–≤—ä—Ä –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω –ø–æ—Ä—Ç 80

// –ì–õ–û–ë–ê–õ–ù–ò –ù–ê–°–¢–†–û–ô–ö–ò (–¢–µ–∑–∏, –∫–æ–∏—Ç–æ –º–µ—Å—Ç–∏—à –æ—Ç —Å–∞–π—Ç–∞)
int threshold = 800;       // –ö–æ–ª–∫–æ —Å–∏–ª–Ω–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –≤–∏–∫–Ω–µ, –∑–∞ –¥–∞ –ø–æ—á–Ω–µ –∑–∞–ø–∏—Å
int silenceGap = 5;        // –ö–æ–ª–∫–æ —Å–µ–∫—É–Ω–¥–∏ —Ç–∏—à–∏–Ω–∞ —Å–ø–∏—Ä–∞—Ç –∑–∞–ø–∏—Å–∞
int maxLenMin = 10;        // –ú–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç–∏ –Ω–∞ –µ–¥–∏–Ω —Ñ–∞–π–ª
uint32_t currentSampleRate = 16000; // –ß–µ—Å—Ç–æ—Ç–∞ –Ω–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏—è (–∫–∞—á–µ—Å—Ç–≤–æ)
bool isPaused = false;     // –î–∞–ª–∏ –°–∏–π–∫–∞ –µ –≤ –ø–æ—á–∏–≤–∫–∞
bool wifiOn = true;        // –î–∞–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—ä—Ç –µ –ø—É—Å–Ω–∞—Ç

#define BUFFER_SIZE 1024   // –†–∞–∑–º–µ—Ä –Ω–∞ –ø–∞—Ä—á–µ—Ç–æ –∞—É–¥–∏–æ, –∫–æ–µ—Ç–æ –æ–±—Ä–∞–±–æ—Ç–≤–∞–º–µ –Ω–∞–≤–µ–¥–Ω—ä–∂

// –§–£–ù–ö–¶–ò–Ø –ó–ê –ù–ê–°–¢–†–û–ô–ö–ê –ù–ê –ú–ò–ö–†–û–§–û–ù–ê
void setupI2S(uint32_t rate) {
  i2s_driver_uninstall(I2S_NUM_0); // –ú–∞—Ö–∞–º–µ —Å—Ç–∞—Ä–∞—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, –∞–∫–æ —Å–º–µ–Ω—è–º–µ –∫–∞—á–µ—Å—Ç–≤–æ—Ç–æ
  i2s_config_t cfg = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX), // ESP32 –µ –≥–æ—Å–ø–æ–¥–∞—Ä, –º–∏–∫—Ä–æ—Ñ–æ–Ω—ä—Ç —Å–ª—É—à–∞
    .sample_rate = rate,                                // –ö–æ–ª–∫–æ –ø—ä—Ç–∏ –≤ —Å–µ–∫—É–Ω–¥–∞ –≤–∑–µ–º–∞–º–µ –ø—Ä–æ–±–∞
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,       // 16-–±–∏—Ç–æ–≤–∞ —Ä–µ–∑–æ–ª—é—Ü–∏—è
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,        // –ú–æ–Ω–æ –∑–∞–ø–∏—Å
    .communication_format = I2S_COMM_FORMAT_STAND_I2S,  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω I2S –ø—Ä–æ—Ç–æ–∫–æ–ª
    .dma_buf_count = 8,                                 // –ë—Ä–æ–π –±—É—Ñ–µ—Ä–∏ (–≤—ä–∑–≥–ª–∞–≤–Ω–∏—Ü–∏ –∑–∞ –¥–∞–Ω–Ω–∏)
    .dma_buf_len = 512,                                 // –î—ä–ª–∂–∏–Ω–∞ –Ω–∞ –≤—Å–µ–∫–∏ –±—É—Ñ–µ—Ä
    .use_apll = true                                    // –ü–û–î–û–ë–†–ï–ù–ò–ï–¢–û: –í–∏—Å–æ–∫–æ—Ç–æ—á–µ–Ω –∞—É–¥–∏–æ —á–∞—Å–æ–≤–Ω–∏–∫
  };
  i2s_driver_install(I2S_NUM_0, &cfg, 0, NULL);         // –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–º–µ –¥—Ä–∞–π–≤–µ—Ä–∞
  i2s_pin_config_t pins = {
    .bck_io_num=I2S_SCK, 
    .ws_io_num=I2S_WS, 
    .data_out_num=-1,                                   // –ù—è–º–∞–º–µ –≥–æ–≤–æ—Ä–∏—Ç–µ–ª
    .data_in_num=I2S_SD                                 // –ú–∏–∫—Ä–æ—Ñ–æ–Ω—ä—Ç –µ —Ç—É–∫
  };
  i2s_set_pin(I2S_NUM_0, &pins);                        // –°–≤—ä—Ä–∑–≤–∞–º–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ç–µ –ø–∏–Ω–æ–≤–µ
}

// –§–£–ù–ö–¶–ò–Ø –ó–ê –°–™–ó–î–ê–í–ê–ù–ï –ù–ê WAV –ó–ê–ì–õ–ê–í–ò–ï (Header)
// –ë–µ–∑ —Ç–æ–≤–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ä—Ç –Ω—è–º–∞ –¥–∞ —Å–µ –æ—Ç–≤–æ—Ä–∏ –Ω–∞ –Ω–∏—Ç–æ –µ–¥–∏–Ω –ø–ª–µ—ä—Ä
void writeHeader(File f, uint32_t dSize, uint32_t rate) {
  f.seek(0); // –û—Ç–∏–≤–∞–º–µ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ —Ñ–∞–π–ª–∞
  uint32_t fSize = dSize + 36;
  uint32_t br = rate * 2; // Byte rate (–∑–∞ –º–æ–Ω–æ 16-–±–∏—Ç –µ Rate * 2)
  // –ú–∞—Å–∏–≤ –æ—Ç 44 –±–∞–π—Ç–∞, –∫–æ–π—Ç–æ –∫–∞–∑–≤–∞ –Ω–∞ –∫–æ–º–ø—é—Ç—ä—Ä–∞ "–ê–∑ —Å—ä–º WAV, —Å–≤–∏—Ä–∏ –º–µ —Å X —á–µ—Å—Ç–æ—Ç–∞"
  byte h[44] = {'R','I','F','F',0,0,0,0,'W','A','V','E','f','m','t',' ',16,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,'d','a','t','a',0,0,0,0};
  memcpy(&h[4], &fSize, 4); memcpy(&h[24], &rate, 4); memcpy(&h[28], &br, 4); memcpy(&h[40], &dSize, 4);
  f.write(h, 44);
}

// –ì–õ–ê–í–ù–ê–¢–ê –°–¢–†–ê–ù–ò–¶–ê (HTML –∫–æ–¥—ä—Ç, –∫–æ–π—Ç–æ –≤–∏–∂–¥–∞—à –≤ –±—Ä–∞—É–∑—ä—Ä–∞)
void handleRoot() {
  // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –Ω–∞—Ç–∏—Å–Ω–∞–ª "–ó–ê–ü–ê–ó–ò" —Å –Ω–æ–≤–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  if (server.hasArg("th")) threshold = server.arg("th").toInt();
  if (server.hasArg("gap")) silenceGap = server.arg("gap").toInt();
  if (server.hasArg("len")) maxLenMin = server.arg("len").toInt();
  if (server.hasArg("rate")) {
    uint32_t newRate = server.arg("rate").toInt();
    if (newRate != currentSampleRate) {
      currentSampleRate = newRate;
      setupI2S(currentSampleRate); // –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —Å –Ω–æ–≤–æ—Ç–æ –∫–∞—á–µ—Å—Ç–≤–æ
    }
  }

  // –ò–∑–≥—Ä–∞–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –ø–∞—Ä—á–µ –ø–æ –ø–∞—Ä—á–µ
  String h = "<html><head><meta name='viewport' content='width=device-width, initial-scale=1'><meta charset='UTF-8'></head>";
  h += "<body style='font-family:sans-serif; padding:15px; background:#fafafa;'>";
  h += "<h2>–°–∏–π–∫–∞ v6.2 (Full Control)</h2>";
  h += "<div style='padding:10px; background:#fff; border-radius:5px; border:1px solid #ddd; margin-bottom:10px;'>";
  h += "–°—Ç–∞—Ç—É—Å: " + String(isPaused ? "<b style='color:red;'>–°–ü–†–Ø–ù–ê</b>" : "<b style='color:green;'>–°–õ–£–®–ê</b>") + "<br><br>";
  h += "<a href='/toggle'><button style='padding:10px;'>–ü–£–°–ù–ò/–°–ü–†–ò</button></a> ";
  h += "<a href='/'><button style='padding:10px;'>–û–ü–†–ï–°–ù–ò</button></a><hr>";
  
  // –§–æ—Ä–º–∞—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
  h += "<form style='line-height:2.0;'>";
  h += "–ö–∞—á–µ—Å—Ç–≤–æ: <select name='rate'>";
  h += "<option value='16000' "+String(currentSampleRate==16000?"selected":"")+">16kHz</option>";
  h += "<option value='22050' "+String(currentSampleRate==22050?"selected":"")+">22kHz</option>";
  h += "<option value='44100' "+String(currentSampleRate==44100?"selected":"")+">44.1kHz</option></select><br>";
  h += "–ü—Ä–∞–≥ —à—É–º: <input name='th' value='"+String(threshold)+"' size='4'><br>";
  h += "–¢–∏—à–∏–Ω–∞ (—Å–µ–∫): <input name='gap' value='"+String(silenceGap)+"' size='2'><br>";
  h += "–ú–∞–∫—Å. –¥—ä–ª–∂ (–º–∏–Ω): <input name='len' value='"+String(maxLenMin)+"' size='2'><br>";
  h += "<input type='submit' style='margin-top:10px; padding:5px 20px;' value='–ó–ê–ü–ê–ó–ò'></form></div>";
  
  // –°–ø–∏—Å—ä–∫ —Å —Ñ–∞–π–ª–æ–≤–µ—Ç–µ –æ—Ç SD –∫–∞—Ä—Ç–∞—Ç–∞
  File root = SD.open("/");
  File f = root.openNextFile();
  while(f){
    String n = String(f.name());
    if(n.endsWith(".wav")){
      if(n.startsWith("/")) n.remove(0,1);
      h += "<div>üíæ <a href='/dl?f="+n+"'><b>"+n+"</b></a> ("+String(f.size()/1024)+"KB) | <a href='/del?f="+n+"' style='color:red;'>[X]</a></div><br>";
    }
    f = root.openNextFile();
  }
  h += "</body></html>";
  server.send(200, "text/html", h); // –ò–∑–ø—Ä–∞—â–∞–º–µ –≥–æ—Ç–æ–≤–∏—è HTML –∫—ä–º –±—Ä–∞—É–∑—ä—Ä–∞
}

void setup() {
  Serial.begin(115200);
  pinMode(BTN_PIN, INPUT_PULLUP); // –ù–∞—Å—Ç—Ä–æ–π–≤–∞–º–µ –±—É—Ç–æ–Ω–∞ BOOT
  
  WiFi.begin(ssid, pass); // –ó–∞–ø–æ—á–≤–∞–º–µ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å —Ä—É—Ç–µ—Ä–∞
  while (WiFi.status() != WL_CONNECTED) { delay(500); } // –ß–∞–∫–∞–º–µ –≤—Ä—ä–∑–∫–∞
  
  Wire.begin(I2C_SDA, I2C_SCL); // –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —á–∞—Å–æ–≤–Ω–∏–∫–∞
  rtc.begin();
  
  SPI.begin(SD_SCK, SD_MISO, SD_MOSI, SD_CS); // –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ SD –∫–∞—Ä—Ç–∞—Ç–∞
  if (!SD.begin(SD_CS)) Serial.println("SD Card Error!");
  
  setupI2S(currentSampleRate); // –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

  // –î–ï–§–ò–ù–ò–†–ê–ù–ï –ù–ê –ü–™–¢–ò–©–ê–¢–ê –í –£–ï–ë –°–ê–ô–¢–ê
  server.on("/", handleRoot);
  server.on("/toggle", [](){ isPaused = !isPaused; server.sendHeader("Location", "/"); server.send(303); });
  server.on("/dl", [](){ // –§–£–ù–ö–¶–ò–Ø –ó–ê –°–í–ê–õ–Ø–ù–ï
    String n = server.arg("f");
    File f = SD.open("/" + n, "r");
    server.sendHeader("Content-Disposition", "attachment; filename=\"" + n + "\"");
    server.streamFile(f, "audio/wav");
    f.close();
  });
  server.on("/del", [](){ // –§–£–ù–ö–¶–ò–Ø –ó–ê –¢–†–ò–ï–ù–ï
    SD.remove("/"+server.arg("f")); 
    server.sendHeader("Location", "/"); 
    server.send(303); 
  });
  server.begin(); // –ü—É—Å–∫–∞–º–µ —Å—ä—Ä–≤—ä—Ä–∞
}

void loop() {
  // –¢—É–∫ –º–æ–∂–µ—à –¥–∞ –º–∞—Ö–Ω–µ—à –∫–æ–º–µ–Ω—Ç–∞—Ä–∏—Ç–µ, –∞–∫–æ –∏—Å–∫–∞—à –±—É—Ç–æ–Ω—ä—Ç BOOT –¥–∞ –≥–∞—Å–∏ WiFi
  /* if (digitalRead(BTN_PIN) == LOW) {
    delay(500);
    if (wifiOn) { WiFi.disconnect(); WiFi.mode(WIFI_OFF); wifiOn = false; }
    else { WiFi.begin(ssid, pass); wifiOn = true; }
    while(digitalRead(BTN_PIN) == LOW);
  } */

  if (wifiOn) server.handleClient(); // –°—ä—Ä–≤—ä—Ä—ä—Ç —Å–ª—É—à–∞ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è
  if (isPaused) { delay(10); return; } // –ê–∫–æ –µ –Ω–∞ –ø–∞—É–∑–∞, –Ω–µ –ø—Ä–∞–≤–∏–º –Ω–∏—â–æ

  // –ß–ï–¢–ï–ù–ï –ù–ê –ú–ò–ö–†–û–§–û–ù–ê
  int16_t sBuf[BUFFER_SIZE];
  size_t r;
  i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10);
  
  // –¢–™–†–°–ï–ù–ï –ù–ê –ù–ê–ô-–°–ò–õ–ù–ò–Ø –ó–í–£–ö (Peak)
  int peak = 0;
  for (int i=0; i<r/2; i++) if(abs(sBuf[i]) > peak) peak = abs(sBuf[i]);

  // –ê–ö–û –ï –ü–û-–®–£–ú–ù–û –û–¢ –ü–†–ê–ì–ê - –ó–ê–ü–û–ß–í–ê–ú–ï –ó–ê–ü–ò–°
  if (peak > threshold) {
    DateTime now = rtc.now();
    char fn[32]; 
    sprintf(fn, "/%02d-%02d_%02d-%02d-%02d.wav", now.day(), now.month(), now.hour(), now.minute(), now.second());
    
    File file = SD.open(fn, FILE_WRITE);
    if(file){
      file.write((const byte*)sBuf, 44); // –û—Å—Ç–∞–≤—è–º–µ –º—è—Å—Ç–æ –∑–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ (header)
      uint32_t total = 0;
      int sil = 0;
      int webCounter = 0;

      // –¶–ò–ö–™–õ –ó–ê –ó–ê–ü–ò–° (–î–æ–∫–∞—Ç–æ –∏–º–∞ —à—É–º –∏–ª–∏ –¥–æ 10 –º–∏–Ω—É—Ç–∏)
      while(total < (uint32_t)maxLenMin * 60 * currentSampleRate * 2){
        // –ù–∞ –≤—Å–µ–∫–∏ 25 —Ü–∏–∫—ä–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ —É–µ–± —Å—ä—Ä–≤—ä—Ä–∞, –∑–∞ –¥–∞ –Ω–µ "–∑–∞–º—Ä—ä–∑–Ω–µ" —Å–∞–π—Ç–∞
        if(wifiOn && ++webCounter > 25) { server.handleClient(); webCounter = 0; }
        
        i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, portMAX_DELAY);
        file.write((const byte*)sBuf, r);
        total += r;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Ç–∏—à–∏–Ω–∞
        int p = 0;
        for(int i=0; i<r/2; i++) if(abs(sBuf[i]) > p) p = abs(sBuf[i]);
        if(p < (threshold * 0.75)) sil++; else sil = 0;
        
        // –ü–û–î–û–ë–†–ï–ù–ò–ï–¢–û: –¢–æ—á–Ω–æ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–≥–∞ —Å–∞ –º–∏–Ω–∞–ª–∏ –∑–∞–¥–∞–¥–µ–Ω–∏—Ç–µ —Å–µ–∫—É–Ω–¥–∏ —Ç–∏—à–∏–Ω–∞
        if(sil > (silenceGap * (currentSampleRate / (BUFFER_SIZE/2))) || isPaused) break;
      }
      writeHeader(file, total, currentSampleRate); // –ü–æ–ø—ä–ª–≤–∞–º–µ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ —Å —Ñ–∏–Ω–∞–ª–Ω–∏—è —Ä–∞–∑–º–µ—Ä
      file.close();
    }
  }
}