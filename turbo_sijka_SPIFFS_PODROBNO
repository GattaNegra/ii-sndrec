// * Turbo –°–ò–ô–ö–ê v8.64 (2C SPIFFS)
// * Copyright (C) 2026 GattaNegra gattanegrabg@gmail.com
// * * This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License.

#include <WiFi.h>
#include <WebServer.h>
#include <SPIFFS.h>      // –í—ä—Ç—Ä–µ—à–Ω–∞ —Ñ–ª–∞—à –ø–∞–º–µ—Ç –Ω–∞ ESP32
#include <driver/i2s.h>  // –î—Ä–∞–π–≤–µ—Ä –∑–∞ —Ü–∏—Ñ—Ä–æ–≤–æ –∞—É–¥–∏–æ
#include <ThreeWire.h>   // –ü—Ä–æ—Ç–æ–∫–æ–ª –∑–∞ –≤—Ä—ä–∑–∫–∞ —Å —á–∞—Å–æ–≤–Ω–∏–∫–∞ (3-–∂–∏–ª–µ–Ω)
#include <RtcDS1302.h>   // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞ DS1302
#include <WiFiManager.h> // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—ä–∑–¥–∞–≤–∞ AP –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ WiFi

// –î–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∏–Ω–æ–≤–µ—Ç–µ
#define BTN_WIFI 4       // –§–∏–∑–∏—á–µ—Å–∫–∏ –±—É—Ç–æ–Ω (–ø–∞—Ä–∏—á–∫–∞—Ç–∞)
#define LED_WIFI 2       // –í–≥—Ä–∞–¥–µ–Ω –¥–∏–æ–¥ –Ω–∞ –ø–ª–∞—Ç–∫–∞—Ç–∞
#define I2S_WS 25        // Word Select (L/R Clock) –∑–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
#define I2S_SD 33        // Serial Data –æ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
#define I2S_SCK 32       // Serial Clock –∑–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

// –û–±–µ–∫—Ç –∑–∞ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å —á–∞—Å–æ–≤–Ω–∏–∫–∞ (DAT, CLK, RST)
ThreeWire myWire(27, 14, 26); 
RtcDS1302<ThreeWire> Rtc(myWire);
WebServer server(80);

// –ì–ª–æ–±–∞–ª–Ω–∏ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø—Ä–æ–º–µ–Ω—è—Ç —Å–µ –æ—Ç —É–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
uint32_t sampleRate = 16000;  // –ß–µ—Å—Ç–æ—Ç–∞ –Ω–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏—è (–∫–∞—á–µ—Å—Ç–≤–æ)
int threshold = 800;          // –ü—Ä–∞–≥, –Ω–∞–¥ –∫–æ–π—Ç–æ –∑–∞–ø–æ—á–≤–∞ –∑–∞–ø–∏—Å
int hysteresis = 150;         // –¢–æ–ª–µ—Ä–∞–Ω—Å, –∑–∞ –¥–∞ –Ω–µ —Å–ø–∏—Ä–∞ –ø—Ä–∏ –Ω–∞–π-–º–∞–ª–∫–∏—è —Å–ø–∞–¥
uint32_t maxDuration = 60;    // –ú–∞–∫—Å–∏–º–∞–ª–Ω–∞ –¥—ä–ª–∂–∏–Ω–∞ –Ω–∞ –µ–¥–∏–Ω —Ñ–∞–π–ª –≤ —Å–µ–∫—É–Ω–¥–∏
volatile bool isPaused = true; // –î–∞–ª–∏ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –µ –≤ —Ä–µ–∂–∏–º "–ü–∞—É–∑–∞"
volatile bool formatRequest = false; // –§–ª–∞–≥ –∑–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç—Ç–∞
bool wifiEnabled = true;      // –°—Ç–∞—Ç—É—Å –Ω–∞ WiFi –º–æ–¥—É–ª–∞

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∞—É–¥–∏–æ –≤—Ö–æ–¥–∞ (I2S)
void setupI2S(uint32_t rate) {
  i2s_driver_uninstall(I2S_NUM_0); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ —Å—Ç–∞—Ä–∏—è –¥—Ä–∞–π–≤–µ—Ä, –∞–∫–æ —Å–º–µ–Ω—è–º–µ Hz
  i2s_config_t cfg = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX), // ESP32 –µ –≤–æ–¥–µ—â, —Å–∞–º–æ –ø—Ä–∏–µ–º–∞
    .sample_rate = rate,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,         // –ü–æ–ª–∑–≤–∞–º–µ —Å–∞–º–æ –µ–¥–∏–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω
    .communication_format = I2S_COMM_FORMAT_STAND_I2S,
    .dma_buf_count = 8,                                  // –ë—Ä–æ–π –±—É—Ñ–µ—Ä–∏ –∑–∞ –ø–ª–∞–≤–Ω–∞ —Ä–∞–±–æ—Ç–∞
    .dma_buf_len = 512,                                  // –†–∞–∑–º–µ—Ä –Ω–∞ –≤—Å–µ–∫–∏ –±—É—Ñ–µ—Ä
    .use_apll = false 
  };
  i2s_driver_install(I2S_NUM_0, &cfg, 0, NULL);
  i2s_pin_config_t pins = {.bck_io_num=I2S_SCK, .ws_io_num=I2S_WS, .data_out_num=-1, .data_in_num=I2S_SD};
  i2s_set_pin(I2S_NUM_0, &pins);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ WAV —Ö–µ–¥—ä—Ä–∞ (–ø—Ä–∞–≤–∏ —Ñ–∞–π–ª–∞ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–µ–º –∑–∞ –ø–ª–µ–π—ä—Ä–∏—Ç–µ)
void writeHeader(File f, uint32_t dSize, uint32_t rate) {
  f.seek(0); // –í—Ä—ä—â–∞–º–µ —Å–µ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ —Ñ–∞–π–ª–∞
  uint32_t fSize = dSize + 36; uint32_t br = rate * 2;
  byte h[44] = {'R','I','F','F',0,0,0,0,'W','A','V','E','f','m','t',' ',16,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,'d','a','t','a',0,0,0,0};
  memcpy(&h[4], &fSize, 4); memcpy(&h[24], &rate, 4); memcpy(&h[28], &br, 4); memcpy(&h[40], &dSize, 4);
  f.write(h, 44);
}

// –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –≥–ª–∞–≤–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ —É–µ–± —Å–∞–π—Ç–∞
void handleRoot() {
  String h = "<html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1'><style>button{height:45px; margin:5px; padding:10px; border-radius:8px;} .file-box{background:#f0f0f0; padding:15px; border-bottom:2px solid #ccc; margin-bottom:10px; border-radius:10px;}</style></head><body>";
  h += "<h1>üéôÔ∏è Turbo –°–ò–ô–ö–ê v8.64 (2C SPIFFS)</h1>";
  size_t total = SPIFFS.totalBytes(); size_t used = SPIFFS.usedBytes();
  h += "–ü–∞–º–µ—Ç: <b>" + String((total - used)/1024) + " KB —Å–≤–æ–±–æ–¥–Ω–∏</b><br>";
  h += "–°–¢–ê–¢–£–°: <b>" + String(isPaused ? "–ì–û–¢–û–í" : "<span style='color:red'>–ó–ê–ü–ò–°–í–ê/–°–õ–£–®–ê</span>") + "</b><hr>";
  
  // –ë—É—Ç–æ–Ω–∏ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  h += "<button onclick=\"location.href='/toggle'\">‚ñ∂ –ü–£–°–ù–ò/–°–ü–†–ò</button><button onclick=\"location.href='/'\">üîÑ –û–ü–†–ï–°–ù–ò</button><hr>";
  
  // –§–æ—Ä–º–∞ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  h += "<h3>‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:</h3><form action='/set'>";
  h += "Hz: <input type='number' name='hz' value='"+String(sampleRate)+"' style='width:80px'> ";
  h += "Th: <input type='number' name='th' value='"+String(threshold)+"' style='width:60px'><br>";
  h += "Hys: <input type='number' name='hys' value='"+String(hysteresis)+"' style='width:60px'> ";
  h += "Sec: <input type='number' name='sec' value='"+String(maxDuration)+"' style='width:60px'><br>";
  h += "<input type='submit' value='–ó–ê–ü–ê–ó–ò –ù–ê–°–¢–†–û–ô–ö–ò–¢–ï'></form><hr><h3>üìÅ –ó–ê–ü–ò–°–ò:</h3>";
  
  // –°–ø–∏—Å—ä–∫ —Å —Ñ–∞–π–ª–æ–≤–µ –≤ –ø–∞–º–µ—Ç—Ç–∞
  File root = SPIFFS.open("/"); File f = root.openNextFile();
  while(f){
    String n = f.name(); if(n.endsWith(".wav")){
      String path = n.startsWith("/") ? n : "/" + n;
      h += "<div class='file-box'><b>"+n+"</b> ("+String(f.size()/1024)+" KB)<br><audio controls style='width:100%; margin:10px 0;'><source src='/stream?f="+path+"' type='audio/wav'></audio><br>";
      h += "<a href='/dl?f="+path+"'>üì• –°–í–ê–õ–ò</a> | <a href='/del?f="+path+"' style='color:red'>[–ò–ó–¢–†–ò–ô]</a></div>";
    } f = root.openNextFile();
  }
  h += "<hr><button style='background:#fee; color:red' onclick=\"if(confirm('–¢–†–ò–ï–® –í–°–ò–ß–ö–û?')) location.href='/format'\">‚ö† –§–û–†–ú–ê–¢–ò–†–ê–ô –ü–ê–ú–ï–¢–¢–ê</button></body></html>";
  server.send(200, "text/html", h);
}

void setup() {
  Serial.begin(115200);
  pinMode(BTN_WIFI, INPUT_PULLUP);
  pinMode(LED_WIFI, OUTPUT);
  digitalWrite(LED_WIFI, HIGH); 
  SPIFFS.begin(true); // true = —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∞–∫–æ –ø–∞–º–µ—Ç—Ç–∞ –µ –ø–æ–≤—Ä–µ–¥–µ–Ω–∞
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–≤–µ—Ä—è–≤–∞–Ω–µ –Ω–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞
  Rtc.Begin();
  Rtc.SetIsWriteProtected(false); // –û—Ç–∫–ª—é—á–≤–∞–º–µ –∑–∞ –ø–∏—Å–∞–Ω–µ
  Rtc.SetIsRunning(true);         // –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –±—Ä–æ–µ–Ω–µ—Ç–æ
  
  RtcDateTime compiled = RtcDateTime(__DATE__, __TIME__);
  RtcDateTime current = Rtc.GetDateTime();
  
  // –ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ 2099 –≥.: –∞–∫–æ —á–∏–ø—ä—Ç –µ –∏–∑–≤—ä–Ω —Ä–µ–∞–ª–Ω–∏ –≥—Ä–∞–Ω–∏—Ü–∏, —Å–≤–µ—Ä—è–≤–∞–º–µ —Å —á–∞—Å–∞ –Ω–∞ –∫–æ–º–ø–∏–ª–∞—Ü–∏—è
  if (current.Year() > 2090 || current.Year() < 2024) {
    Rtc.SetDateTime(compiled); 
  }

  // WiFi –ú–µ–Ω–∏–¥–∂—ä—Ä - –∞–∫–æ –Ω—è–º–∞ –º—Ä–µ–∂–∞, –ø—É—Å–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ AP "Siyka_Turbo_AP"
  WiFiManager wm;
  wm.autoConnect("Siyka_Turbo_AP");
  setupI2S(sampleRate);

  // –î–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–µ –Ω–∞ —É–µ–± –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ
  server.on("/", handleRoot);
  server.on("/toggle", [](){ isPaused = !isPaused; server.sendHeader("Location", "/"); server.send(303); });
  server.on("/set", [](){ 
    sampleRate = server.arg("hz").toInt(); 
    threshold = server.arg("th").toInt(); 
    hysteresis = server.arg("hys").toInt();
    maxDuration = server.arg("sec").toInt(); 
    setupI2S(sampleRate);
    server.sendHeader("Location", "/"); server.send(303); 
  });
  server.on("/del", [](){ String n = server.arg("f"); if(!n.startsWith("/")) n = "/" + n; SPIFFS.remove(n); server.sendHeader("Location", "/"); server.send(303); });
  server.on("/format", [](){ formatRequest = true; server.send(200, "text/html", "Formatting..."); });
  server.on("/stream", [](){ String n = server.arg("f"); if(!n.startsWith("/")) n = "/" + n; File f = SPIFFS.open(n, "r"); server.streamFile(f, "audio/wav"); f.close(); });
  server.on("/dl", [](){ String n = server.arg("f"); if(!n.startsWith("/")) n = "/" + n; File f = SPIFFS.open(n, "r"); server.sendHeader("Content-Disposition", "attachment; filename=" + n.substring(1)); server.streamFile(f, "application/octet-stream"); f.close(); });

  server.begin();

  // –ü—É—Å–∫–∞–º–µ –£–µ–± —Å—ä—Ä–≤—ä—Ä–∞ –Ω–∞ –Ø–¥—Ä–æ 0 (–≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –Ω–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ)
  xTaskCreatePinnedToCore([](void*p){for(;;){server.handleClient();vTaskDelay(5);}}, "Web", 8192, NULL, 1, NULL, 0);
  // –ü—É—Å–∫–∞–º–µ –ê—É–¥–∏–æ –∑–∞–ø–∏—Å–∞ –Ω–∞ –Ø–¥—Ä–æ 1 (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –Ω–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ)
  xTaskCreatePinnedToCore(AudioTask, "Audio", 8192, NULL, 4, NULL, 1);
}

// –ì–ª–∞–≤–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∑–∞–ø–∏—Å
void AudioTask(void * pvParameters) {
  int16_t sBuf[512]; // –ë—É—Ñ–µ—Ä –∑–∞ —Ç–µ–∫—É—â–∏—è –∑–≤—É–∫
  size_t r;
  for(;;) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—è –±—É—Ç–æ–Ω –∑–∞ WiFi
    if (digitalRead(BTN_WIFI) == LOW) {
      vTaskDelay(50);
      if (digitalRead(BTN_WIFI) == LOW) {
        wifiEnabled = !wifiEnabled;
        if (wifiEnabled) { WiFi.mode(WIFI_STA); WiFi.begin(); digitalWrite(LED_WIFI, HIGH); }
        else { WiFi.mode(WIFI_OFF); digitalWrite(LED_WIFI, LOW); }
        while(digitalRead(BTN_WIFI) == LOW) vTaskDelay(10);
      }
    }

    // –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –ø—Ä–∏ –∑–∞—è–≤–∫–∞ –∑–∞ —Ñ–æ—Ä–º–∞—Ç
    if (formatRequest) { SPIFFS.format(); ESP.restart(); }

    if (!isPaused) {
      // –ü–æ—Å—Ç–æ—è–Ω–Ω–æ —á–µ—Ç–µ–º –æ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –∑–∞ –¥–∞ —Ö–≤–∞–Ω–µ–º –ø–∏–∫
      i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10);
      int peak = 0;
      for (int i=0; i<r/2; i++) if(abs(sBuf[i]) > peak) peak = abs(sBuf[i]);

      // –ê–∫–æ –∑–≤—É–∫—ä—Ç –Ω–∞–¥–≤–∏—à–∏ –ø—Ä–∞–≥–∞ (threshold), –ø–æ—á–≤–∞–º–µ –Ω–æ–≤ —Ñ–∞–π–ª
      if (peak > threshold) {
        RtcDateTime now = Rtc.GetDateTime();
        char fn[64];
        // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∏–º–µ—Ç–æ: –ì–æ–¥–∏–Ω–∞-–ú–µ—Å–µ—Ü-–î–µ–Ω_–ß–∞—Å-–ú–∏–Ω-–°–µ–∫
        sprintf(fn, "/%04d-%02d-%02d_%02d-%02d-%02d.wav", now.Year(), now.Month(), now.Day(), now.Hour(), now.Minute(), now.Second());
        
        File file = SPIFFS.open(fn, FILE_WRITE);
        if(file) {
          file.write(new byte[44], 44); // –†–µ–∑–µ—Ä–≤–∏—Ä–∞–º–µ –º—è—Å—Ç–æ –∑–∞ WAV —Ö–µ–¥—ä—Ä–∞
          uint32_t total = 0;
          unsigned long startM = millis();
          
          // –¶–∏–∫—ä–ª –Ω–∞ —Å–∞–º–∏—è –∑–∞–ø–∏—Å - –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞ –¥–æ maxDuration –∏–ª–∏ –¥–æ —Å–ø–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∞—É–∑–∞
          while(!isPaused && (millis() - startM < maxDuration * 1000) && total < 3000000) {
            if (i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10) == ESP_OK && r > 0) {
              file.write((const byte*)sBuf, r);
              total += r;
            }
          }
          // –°–ª–µ–¥ –∫–∞—Ç–æ –∑–∞—Ç–≤–æ—Ä–∏–º, –ø–æ–ø—ä–ª–≤–∞–º–µ —Ö–µ–¥—ä—Ä–∞ —Å —Ä–µ–∞–ª–Ω–∏—è —Ä–∞–∑–º–µ—Ä –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ
          writeHeader(file, total, sampleRate);
          file.close();
        }
      }
    }
    vTaskDelay(1); // –ö—Ä–∞—Ç–∫–∞ –ø–∞—É–∑–∞, –∑–∞ –¥–∞ –Ω–µ –ø—Ä–µ–≥—Ä—è–≤–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ä—ä—Ç
  }
}

// loop() –æ—Å—Ç–∞–≤–∞ –ø—Ä–∞–∑–µ–Ω, –∑–∞—â–æ—Ç–æ –≤—Å–∏—á–∫–æ —Ä–∞–±–æ—Ç–∏ –≤ Tasks –Ω–∞ –¥–≤–µ—Ç–µ —è–¥—Ä–∞
void loop() {}
