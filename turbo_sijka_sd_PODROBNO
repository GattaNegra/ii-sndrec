#include <WiFi.h>
#include <WebServer.h>
#include <SPI.h>         // –ö–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å—ä—Å SD –∫–∞—Ä—Ç–∞—Ç–∞ (—Å–µ—Ä–∏–µ–Ω –ø—Ä–æ—Ç–æ–∫–æ–ª)
#include <SD.h>          // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–≤–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ SD –∫–∞—Ä—Ç–∞—Ç–∞
#include <driver/i2s.h>  // –î—Ä–∞–π–≤–µ—Ä –∑–∞ –¥–∏–≥–∏—Ç–∞–ª–µ–Ω –∑–≤—É–∫ (–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
#include <Wire.h>        // I2C –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è (–∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞)
#include "RTClib.h"      // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ DS3231 —á–∞—Å–æ–≤–Ω–∏–∫
#include <WiFiManager.h> // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º–µ–Ω—é –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –∫—ä–º WiFi

// –î–ï–§–ò–ù–ò–¶–ò–ò –ù–ê –ü–ò–ù–û–í–ï - –¢—Ä—è–±–≤–∞ –¥–∞ —Å—ä–≤–ø–∞–¥–∞—Ç —Å –∫–∞–±–µ–ª–∏—Ç–µ!
#define SD_CS 5
#define SD_MOSI 23
#define SD_MISO 19
#define SD_SCK 18
#define I2S_WS 25
#define I2S_SD 33
#define I2S_SCK 32
#define I2C_SDA 21
#define I2C_SCL 22
#define BTN_WIFI 4
#define LED_WIFI 2

RTC_DS3231 rtc;      // –û–±–µ–∫—Ç –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞ (–ø–∞–∑–∏ —Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ)
WebServer server(80); // –£–µ–± —Å—ä—Ä–≤—ä—Ä –Ω–∞ –ø–æ—Ä—Ç 80

// –ì–õ–û–ë–ê–õ–ù–ò –ù–ê–°–¢–†–û–ô–ö–ò (–ø—Ä–æ–º–µ–Ω—è—Ç —Å–µ –æ—Ç —É–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
uint32_t sampleRate = 16000;
int threshold = 800;   // –ù–∏–≤–æ –Ω–∞ —à—É–º –∑–∞ —Å—Ç–∞—Ä—Ç –Ω–∞ –∑–∞–ø–∏—Å
int hysteresis = 150;  // –¢–æ–ª–µ—Ä–∞–Ω—Å, –∑–∞ –¥–∞ –Ω–µ –ø—Ä–µ–∫—ä—Å–≤–∞ –∑–∞–ø–∏—Å–∞ –ø—Ä–∏ –º–∞–ª–∫–∏ –∫–æ–ª–µ–±–∞–Ω–∏—è
uint32_t maxDuration = 60; // –ú–∞–∫—Å. –¥—ä–ª–∂–∏–Ω–∞ –Ω–∞ —Ñ–∞–π–ª –≤ —Å–µ–∫—É–Ω–¥–∏
volatile bool isPaused = true; // –î–∞–ª–∏ –°–∏–π–∫–∞ "—Å–ª—É—à–∞" –≤ –º–æ–º–µ–Ω—Ç–∞
bool wifiEnabled = true;
int silLimit = 3;      // –ö–æ–ª–∫–æ —Å–µ–∫—É–Ω–¥–∏ —Ç–∏—à–∏–Ω–∞ —Å–ø–∏—Ä–∞—Ç –∑–∞–ø–∏—Å–∞

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ I2S –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∑–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
void setupI2S(uint32_t rate) {
  i2s_driver_uninstall(I2S_NUM_0); // –ú–∞—Ö–∞ —Å—Ç–∞—Ä–∏—è –¥—Ä–∞–π–≤–µ—Ä –ø—Ä–µ–¥–∏ –ø—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ Hz
  i2s_config_t cfg = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX), // ESP32 –µ –≥–æ—Å–ø–æ–¥–∞—Ä, –º–∏–∫—Ä–æ—Ñ–æ–Ω—ä—Ç –ø—Ä–∞—â–∞
    .sample_rate = rate,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,         // –ü–æ–ª–∑–≤–∞–º–µ –º–æ–Ω–æ
    .communication_format = I2S_COMM_FORMAT_STAND_I2S,
    .dma_buf_count = 8,   // –ë—Ä–æ–π –±—É—Ñ–µ—Ä–∏ (–∫–æ—Ñ–∏—á–∫–∏ –∑–∞ –¥–∞–Ω–Ω–∏)
    .dma_buf_len = 512,   // –†–∞–∑–º–µ—Ä –Ω–∞ –≤—Å—è–∫–∞ –∫–æ—Ñ–∏—á–∫–∞
    .use_apll = false 
  };
  i2s_driver_install(I2S_NUM_0, &cfg, 0, NULL);
  i2s_pin_config_t pins = {.bck_io_num=I2S_SCK, .ws_io_num=I2S_WS, .data_out_num=-1, .data_in_num=I2S_SD};
  i2s_set_pin(I2S_NUM_0, &pins);
}

// –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ WAV –∑–∞–≥–ª–∞–≤–∏–µ (44 –±–∞–π—Ç–∞), –∫–æ–µ—Ç–æ –∫–∞–∑–≤–∞ –Ω–∞ –∫–æ–º–ø—é—Ç—ä—Ä–∞ "–ê–∑ —Å—ä–º –∞—É–¥–∏–æ —Ñ–∞–π–ª"
void writeHeader(File f, uint32_t dSize, uint32_t rate) {
  f.seek(0); // –û—Ç–∏–≤–∞ –≤ —Å–∞–º–æ—Ç–æ –Ω–∞—á–∞–ª–æ –Ω–∞ —Ñ–∞–π–ª–∞
  uint32_t fSize = dSize + 36; 
  uint32_t br = rate * 2; // –ë–∞–π—Ç —Ä–µ–π—Ç (rate * 1 –∫–∞–Ω–∞–ª * 2 –±–∞–π—Ç–∞)
  byte h[44] = {'R','I','F','F',0,0,0,0,'W','A','V','E','f','m','t',' ',16,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,'d','a','t','a',0,0,0,0};
  memcpy(&h[4], &fSize, 4);   // –†–∞–∑–º–µ—Ä –Ω–∞ —Ü–µ–ª–∏—è —Ñ–∞–π–ª
  memcpy(&h[24], &rate, 4);   // –ß–µ—Å—Ç–æ—Ç–∞ (Hz)
  memcpy(&h[28], &br, 4);     // –ë–∞–π—Ç–æ–≤–µ –≤ —Å–µ–∫—É–Ω–¥–∞
  memcpy(&h[40], &dSize, 4);  // –†–∞–∑–º–µ—Ä —Å–∞–º–æ –Ω–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω–∏—Ç–µ
  f.write(h, 44);             // –ó–∞–ø–∏—Å–≤–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ –≤—ä—Ä—Ö—É –ø—Ä–∞–∑–Ω–∏—Ç–µ –±–∞–π—Ç–æ–≤–µ
}

// –ì–õ–ê–í–ù–ê–¢–ê –°–¢–†–ê–ù–ò–¶–ê (HTML)
void handleRoot() {
  String h = "<html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1'>";
  h += "<style>button{height:45px; margin:5px; padding:10px; border-radius:8px;} .file-box{background:#f0f0f0; padding:15px; border-bottom:2px solid #ccc; margin-bottom:10px; border-radius:10px;}</style></head><body>";
  h += "<h1>üéôÔ∏è Turbo –°–ò–ô–ö–ê v8.65 (SD)</h1>";
  
  // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç—Ç–∞ –Ω–∞ SD –∫–∞—Ä—Ç–∞—Ç–∞
  uint64_t cardSize = SD.cardSize() / (1024 * 1024);
  uint64_t usedSize = SD.usedBytes() / (1024 * 1024);
  h += "SD –ö–∞—Ä—Ç–∞: <b>" + String(usedSize) + " / " + String(cardSize) + " MB –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏</b><br>";
  h += "–°–¢–ê–¢–£–°: <b>" + String(isPaused ? "–ì–û–¢–û–í" : "<span style='color:red'>–ó–ê–ü–ò–°–í–ê/–°–õ–£–®–ê</span>") + "</b><hr>";
  
  h += "<button onclick=\"location.href='/toggle'\">‚ñ∂ –ü–£–°–ù–ò/–°–ü–†–ò</button><button onclick=\"location.href='/'\">üîÑ –û–ü–†–ï–°–ù–ò</button><hr>";
  
  // –§–æ—Ä–º–∞ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  h += "<h3>‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:</h3><form action='/set'>";
  h += "Hz: <select name='hz'>";
  uint32_t rates[] = {8000, 16000, 32000, 44100, 48000};
  for(int i=0; i<5; i++) { h += "<option value='" + String(rates[i]) + "'" + (sampleRate == rates[i] ? " selected" : "") + ">" + String(rates[i]) + "</option>"; }
  h += "</select> Th: <input type='number' name='th' value='"+String(threshold)+"' style='width:60px'><br>";
  h += "Hys: <input type='number' name='hys' value='"+String(hysteresis)+"' style='width:60px'> Sec: <input type='number' name='sec' value='"+String(maxDuration)+"' style='width:60px'><br>";
  h += "Sil: <input type='number' name='sil' value='"+String(silLimit)+"' style='width:50px'><br>";
  h += "<input type='submit' value='–ó–ê–ü–ê–ó–ò'></form><hr><h3>üìÅ –ó–ê–ü–ò–°–ò (SD):</h3>";
  
  // –û–±—Ö–æ–∂–¥–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ –Ω–∞ SD –∫–∞—Ä—Ç–∞—Ç–∞
  File root = SD.open("/"); File f = root.openNextFile();
  while(f){
    String n = f.name(); if(n.endsWith(".wav")){
      if(n.startsWith("/")) n.remove(0,1);
      h += "<div class='file-box'><b>"+n+"</b> ("+String(f.size()/1024)+" KB)<br>";
      h += "<audio controls style='width:100%; margin:10px 0;'><source src='/stream?f="+n+"' type='audio/wav'></audio><br>";
      h += "<a href='/dl?f="+n+"'>üì• –°–í–ê–õ–ò</a> | <a href='/del?f="+n+"' style='color:red'>[–ò–ó–¢–†–ò–ô]</a></div>";
    } f = root.openNextFile();
  }
  h += "<hr><button style='background:#fee; color:red; width:100%' onclick=\"if(confirm('–¢–†–ò–ï–® –í–°–ò–ß–ö–ò?')) location.href='/format'\">‚ö† –ò–ó–¢–†–ò–ô –í–°–ò–ß–ö–û</button></body></html>";
  server.send(200, "text/html", h);
}

void setup() {
  Serial.begin(115200);
  pinMode(BTN_WIFI, INPUT_PULLUP);
  pinMode(LED_WIFI, OUTPUT);
  digitalWrite(LED_WIFI, HIGH); 
  
  Wire.begin(I2C_SDA, I2C_SCL); // –ü—É—Å–∫–∞ I2C –∑–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞
  rtc.begin();                  // –°—Ç–∞—Ä—Ç–∏—Ä–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞
  
  SPI.begin(SD_SCK, SD_MISO, SD_MOSI, SD_CS); // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —à–∏–Ω–∞—Ç–∞ –∑–∞ SD
  SD.begin(SD_CS);

  WiFiManager wm;
  wm.autoConnect("Siyka_Turbo_SD"); // –û—Ç–≤–∞—Ä—è —Ç–æ—á–∫–∞ –∑–∞ –¥–æ—Å—Ç—ä–ø –ø—Ä–∏ –ª–∏–ø—Å–∞ –Ω–∞ WiFi
  
  setupI2S(sampleRate);
  
  // –£–ï–ë –ú–ê–†–®–†–£–¢–ò (–ö–∞–∫–≤–æ –¥–∞ –ø—Ä–∞–≤–∏ —Å—ä—Ä–≤—ä—Ä–∞ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–µ –Ω–∞ –±—É—Ç–æ–Ω)
  server.on("/", handleRoot);
  server.on("/toggle", [](){ isPaused = !isPaused; server.sendHeader("Location", "/"); server.send(303); });
  server.on("/set", [](){ 
    sampleRate = server.arg("hz").toInt(); threshold = server.arg("th").toInt(); 
    hysteresis = server.arg("hys").toInt(); maxDuration = server.arg("sec").toInt(); 
    silLimit = server.arg("sil").toInt(); setupI2S(sampleRate);
    server.sendHeader("Location", "/"); server.send(303); 
  });
  server.on("/del", [](){ SD.remove("/"+server.arg("f")); server.sendHeader("Location", "/"); server.send(303); });
  server.on("/stream", [](){ File f = SD.open("/" + server.arg("f"), "r"); server.streamFile(f, "audio/wav"); f.close(); });
  server.on("/dl", [](){ String n = server.arg("f"); File f = SD.open("/" + n, "r"); server.sendHeader("Content-Disposition", "attachment; filename=" + n); server.streamFile(f, "application/octet-stream"); f.close(); });
  
  server.on("/format", [](){ 
    File root = SD.open("/"); File f = root.openNextFile();
    while(f){ String n = f.name(); f.close(); if(n.endsWith(".wav")) SD.remove("/"+n); f = root.openNextFile(); }
    server.send(200, "text/html", "–ò–∑—Ç—Ä–∏—Ç–æ! <meta http-equiv='refresh' content='2;url=/'>");
  });

  server.begin();
  
  // –ú–£–õ–¢–ò–¢–ê–°–ö–ò–ù–ì: Core 0 —Å–µ –≥—Ä–∏–∂–∏ –∑–∞ —Å–∞–π—Ç–∞, Core 1 —Å–µ –≥—Ä–∏–∂–∏ —Å–∞–º–æ –∑–∞ –∑–≤—É–∫–∞
  xTaskCreatePinnedToCore([](void*p){for(;;){server.handleClient();vTaskDelay(5);}}, "Web", 8192, NULL, 1, NULL, 0);
  xTaskCreatePinnedToCore(AudioTask, "Audio", 8192, NULL, 4, NULL, 1);
}

// –û–°–ù–û–í–ù–ê –ó–ê–î–ê–ß–ê –ó–ê –ê–£–î–ò–û (–†–ê–ë–û–¢–ò –ù–ê CORE 1)
void AudioTask(void * pvParameters) {
  int16_t sBuf[512]; // –ë—É—Ñ–µ—Ä –∑–∞ —Å–µ–º–ø–ª–∏ (16-–±–∏—Ç–æ–≤–∏ —á–∏—Å–ª–∞)
  size_t r;          // –ö–æ–ª–∫–æ –±–∞–π—Ç–∞ —Å–∞ –ø—Ä–æ—á–µ—Ç–µ–Ω–∏ —Ä–µ–∞–ª–Ω–æ
  for(;;) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—è –±—É—Ç–æ–Ω –∑–∞ WiFi
    if (digitalRead(BTN_WIFI) == LOW) {
        vTaskDelay(50);
        if (digitalRead(BTN_WIFI) == LOW) {
            wifiEnabled = !wifiEnabled;
            if (wifiEnabled) { WiFi.mode(WIFI_STA); WiFi.begin(); digitalWrite(LED_WIFI, HIGH); }
            else { WiFi.mode(WIFI_OFF); digitalWrite(LED_WIFI, LOW); }
            while(digitalRead(BTN_WIFI) == LOW) vTaskDelay(10);
        }
    }

    if (!isPaused) {
      i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10);
      int peak = 0;
      for (int i=0; i<r/2; i++) if(abs(sBuf[i]) > peak) peak = abs(sBuf[i]); // –¢—ä—Ä—Å–∏ –Ω–∞–π-—Å–∏–ª–Ω–∏—è —Å–∏–≥–Ω–∞–ª

      if (peak > threshold) { // –ò–ú–ê –®–£–ú -> –ü–û–ß–í–ê –ó–ê–ü–ò–°
        DateTime now = rtc.now(); // –í–∑–∏–º–∞ –≤—Ä–µ–º–µ—Ç–æ –æ—Ç —á–∞—Å–æ–≤–Ω–∏–∫–∞
        char fn[64];
        sprintf(fn, "/%04d-%02d-%02d_%02d-%02d-%02d.wav", now.year(), now.month(), now.day(), now.hour(), now.minute(), now.second());
        
        File file = SD.open(fn, FILE_WRITE);
        if(file) {
          file.write(new byte[44], 44); // –†–µ–∑–µ—Ä–≤–∏—Ä–∞ –º—è—Å—Ç–æ –∑–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
          uint32_t total = 0;
          unsigned long startM = millis();
          unsigned long lastSoundM = millis(); 
          
          // –¶–∏–∫—ä–ª –Ω–∞ —Å–∞–º–∏—è –∑–∞–ø–∏—Å
          while(!isPaused && (millis() - startM < (unsigned long)maxDuration * 1000)){
            if (i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10) == ESP_OK && r > 0) {
              file.write((const byte*)sBuf, r); // –ü–∏—à–µ –∞—É–¥–∏–æ—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞
              total += r;

              int curPeak = 0;
              for (int i=0; i<r/2; i++) if(abs(sBuf[i]) > curPeak) curPeak = abs(sBuf[i]);

              if (curPeak > (threshold - hysteresis)) lastSoundM = millis(); // –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Ç–∞–π–º–µ—Ä–∞ –∑–∞ —Ç–∏—à–∏–Ω–∞
              
              if (millis() - lastSoundM > (unsigned long)silLimit * 1000) break; // –ú–ª—ä–∫–Ω–∞—Ö–∞ -> —Å–ø–∏—Ä–∞–º–µ
            }
          }
          writeHeader(file, total, sampleRate); // –ü–æ–ø—ä–ª–≤–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ –Ω–∞–∫—Ä–∞—è
          file.close();
        }
      }
    }
    vTaskDelay(1); // –î–∞–≤–∞ –º–∞–ª–∫–æ –≤—Ä–µ–º–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞ –¥–∞ "–¥–∏—à–∞"
  }
}
void loop() {} // –ü—Ä–∞–∑–µ–Ω, –∑–∞—â–æ—Ç–æ –ø–æ–ª–∑–≤–∞–º–µ Task-–æ–≤–µ –Ω–∞ —è–¥—Ä–∞—Ç–∞
