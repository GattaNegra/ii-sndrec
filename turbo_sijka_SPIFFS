#include <WiFi.h>
#include <WebServer.h>
#include <SPIFFS.h>
#include <driver/i2s.h>
#include <ThreeWire.h>
#include <RtcDS1302.h>
#include <WiFiManager.h>

#define BTN_WIFI 4
#define LED_WIFI 2
#define I2S_WS 25
#define I2S_SD 33
#define I2S_SCK 32

ThreeWire myWire(27, 14, 26); 
RtcDS1302<ThreeWire> Rtc(myWire);
WebServer server(80);

uint32_t sampleRate = 16000;
int threshold = 800;
int hysteresis = 150;
uint32_t maxDuration = 60; 
volatile bool isPaused = true; 
volatile bool formatRequest = false;
bool wifiEnabled = true;

void setupI2S(uint32_t rate) {
  i2s_driver_uninstall(I2S_NUM_0);
  i2s_config_t cfg = { .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX), .sample_rate = rate, .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT, .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT, .communication_format = I2S_COMM_FORMAT_STAND_I2S, .dma_buf_count = 8, .dma_buf_len = 512, .use_apll = false };
  i2s_driver_install(I2S_NUM_0, &cfg, 0, NULL);
  i2s_pin_config_t pins = {.bck_io_num=I2S_SCK, .ws_io_num=I2S_WS, .data_out_num=-1, .data_in_num=I2S_SD};
  i2s_set_pin(I2S_NUM_0, &pins);
}

void writeHeader(File f, uint32_t dSize, uint32_t rate) {
  f.seek(0);
  uint32_t fSize = dSize + 36; uint32_t br = rate * 2;
  byte h[44] = {'R','I','F','F',0,0,0,0,'W','A','V','E','f','m','t',' ',16,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,'d','a','t','a',0,0,0,0};
  memcpy(&h[4], &fSize, 4); memcpy(&h[24], &rate, 4); memcpy(&h[28], &br, 4); memcpy(&h[40], &dSize, 4);
  f.write(h, 44);
}

void handleRoot() {
  String h = "<html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1'><style>button{height:45px; margin:5px; padding:10px; border-radius:8px;} .file-box{background:#f0f0f0; padding:15px; border-bottom:2px solid #ccc; margin-bottom:10px; border-radius:10px;}</style></head><body>";
  h += "<h1>üéôÔ∏è –°–ò–ô–ö–ê v8.63</h1>";
  size_t total = SPIFFS.totalBytes(); size_t used = SPIFFS.usedBytes();
  h += "–ü–∞–º–µ—Ç: <b>" + String((total - used)/1024) + " KB —Å–≤–æ–±–æ–¥–Ω–∏</b><br>";
  h += "–°–¢–ê–¢–£–°: <b>" + String(isPaused ? "–ì–û–¢–û–í" : "<span style='color:red'>–ó–ê–ü–ò–°–í–ê/–°–õ–£–®–ê</span>") + "</b><hr>";
  h += "<button onclick=\"location.href='/toggle'\">‚ñ∂ –ü–£–°–ù–ò/–°–ü–†–ò</button><button onclick=\"location.href='/'\">üîÑ –û–ü–†–ï–°–ù–ò</button><hr>";
  h += "<h3>‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:</h3><form action='/set'>";
  h += "Hz: <input type='number' name='hz' value='"+String(sampleRate)+"' style='width:80px'> ";
  h += "Th: <input type='number' name='th' value='"+String(threshold)+"' style='width:60px'><br>";
  h += "Hys: <input type='number' name='hys' value='"+String(hysteresis)+"' style='width:60px'> ";
  h += "Sec: <input type='number' name='sec' value='"+String(maxDuration)+"' style='width:60px'><br>";
  h += "<input type='submit' value='–ó–ê–ü–ê–ó–ò –ù–ê–°–¢–†–û–ô–ö–ò–¢–ï'></form><hr><h3>üìÅ –ó–ê–ü–ò–°–ò:</h3>";
  
  File root = SPIFFS.open("/"); File f = root.openNextFile();
  while(f){
    String n = f.name(); if(n.endsWith(".wav")){
      String path = n.startsWith("/") ? n : "/" + n;
      h += "<div class='file-box'><b>"+n+"</b> ("+String(f.size()/1024)+" KB)<br><audio controls style='width:100%; margin:10px 0;'><source src='/stream?f="+path+"' type='audio/wav'></audio><br>";
      h += "<a href='/dl?f="+path+"'>üì• –°–í–ê–õ–ò</a> | <a href='/del?f="+path+"' style='color:red'>[–ò–ó–¢–†–ò–ô]</a></div>";
    } f = root.openNextFile();
  }
  h += "<hr><button style='background:#fee; color:red' onclick=\"if(confirm('–¢–†–ò–ï–® –í–°–ò–ß–ö–û?')) location.href='/format'\">‚ö† –§–û–†–ú–ê–¢–ò–†–ê–ô –ü–ê–ú–ï–¢–¢–ê</button></body></html>";
  server.send(200, "text/html", h);
}

void setup() {
  Serial.begin(115200);
  pinMode(BTN_WIFI, INPUT_PULLUP);
  pinMode(LED_WIFI, OUTPUT);
  digitalWrite(LED_WIFI, HIGH); 
  SPIFFS.begin(true);
  
  Rtc.Begin();
  Rtc.SetIsWriteProtected(false);
  Rtc.SetIsRunning(true);
  
  RtcDateTime compiled = RtcDateTime(__DATE__, __TIME__);
  RtcDateTime current = Rtc.GetDateTime();
  
  // –ê–∫–æ —á–∞—Å–æ–≤–Ω–∏–∫—ä—Ç –µ –≤ –±—ä–¥–µ—â–µ—Ç–æ (2099) –∏–ª–∏ –º–∏–Ω–∞–ª–æ—Ç–æ, —Å–≤–µ—Ä—è–≤–∞–º–µ –ø–∞–∫
  if (current.Year() > 2090 || current.Year() < 2024) {
    Rtc.SetDateTime(compiled); 
  }

  WiFiManager wm;
  wm.autoConnect("Siyka_Turbo_AP");
  setupI2S(sampleRate);

  server.on("/", handleRoot);
  server.on("/toggle", [](){ isPaused = !isPaused; server.sendHeader("Location", "/"); server.send(303); });
  server.on("/set", [](){ 
    sampleRate = server.arg("hz").toInt(); 
    threshold = server.arg("th").toInt(); 
    hysteresis = server.arg("hys").toInt();
    maxDuration = server.arg("sec").toInt(); 
    setupI2S(sampleRate);
    server.sendHeader("Location", "/"); server.send(303); 
  });
  server.on("/del", [](){ String n = server.arg("f"); if(!n.startsWith("/")) n = "/" + n; SPIFFS.remove(n); server.sendHeader("Location", "/"); server.send(303); });
  server.on("/format", [](){ formatRequest = true; server.send(200, "text/html", "Formatting..."); });
  server.on("/stream", [](){ String n = server.arg("f"); if(!n.startsWith("/")) n = "/" + n; File f = SPIFFS.open(n, "r"); server.streamFile(f, "audio/wav"); f.close(); });
  server.on("/dl", [](){ String n = server.arg("f"); if(!n.startsWith("/")) n = "/" + n; File f = SPIFFS.open(n, "r"); server.sendHeader("Content-Disposition", "attachment; filename=" + n.substring(1)); server.streamFile(f, "application/octet-stream"); f.close(); });

  server.begin();
  xTaskCreatePinnedToCore([](void*p){for(;;){server.handleClient();vTaskDelay(5);}}, "Web", 8192, NULL, 1, NULL, 0);
  xTaskCreatePinnedToCore(AudioTask, "Audio", 8192, NULL, 4, NULL, 1);
}

void AudioTask(void * pvParameters) {
  int16_t sBuf[512];
  size_t r;
  for(;;) {
    if (digitalRead(BTN_WIFI) == LOW) {
      vTaskDelay(50);
      if (digitalRead(BTN_WIFI) == LOW) {
        wifiEnabled = !wifiEnabled;
        if (wifiEnabled) { WiFi.mode(WIFI_STA); WiFi.begin(); digitalWrite(LED_WIFI, HIGH); }
        else { WiFi.mode(WIFI_OFF); digitalWrite(LED_WIFI, LOW); }
        while(digitalRead(BTN_WIFI) == LOW) vTaskDelay(10);
      }
    }

    if (formatRequest) { SPIFFS.format(); ESP.restart(); }

    if (!isPaused) {
      i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10);
      int peak = 0;
      for (int i=0; i<r/2; i++) if(abs(sBuf[i]) > peak) peak = abs(sBuf[i]);

      if (peak > threshold) {
        RtcDateTime now = Rtc.GetDateTime();
        char fn[64];
        // –í–†–™–©–ê–ú –ì–û–î–ò–ù–ê–¢–ê –¢–£–ö: %04d
        sprintf(fn, "/%04d-%02d-%02d_%02d-%02d-%02d.wav", now.Year(), now.Month(), now.Day(), now.Hour(), now.Minute(), now.Second());
        File file = SPIFFS.open(fn, FILE_WRITE);
        if(file) {
          file.write(new byte[44], 44);
          uint32_t total = 0;
          unsigned long startM = millis();
          while(!isPaused && (millis() - startM < maxDuration * 1000) && total < 3000000) {
            if (i2s_read(I2S_NUM_0, &sBuf, sizeof(sBuf), &r, 10) == ESP_OK && r > 0) {
              file.write((const byte*)sBuf, r);
              total += r;
            }
          }
          writeHeader(file, total, sampleRate);
          file.close();
        }
      }
    }
    vTaskDelay(1);
  }
}
void loop() {}
